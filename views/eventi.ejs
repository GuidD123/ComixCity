<!DOCTYPE html>
<html lang="it">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Eventi - ComixCity</title>
  <link rel="stylesheet" href="/css/stile.css" />
</head>

<body data-user="<%= user ? '1' : '0' %>">
  <%- include('partials/navbar1') %>
  <%- include('partials/flashmex') %>

  <section class="background-gradient">

    <!-- HERO EVENTI -->
    <section class="hero3 eventi-hero">
      <div class="hero-content-chisiamo">
        <h1 class="anim-fade-down">Scopri gli Eventi</h1>
        <p class="anim-fade-down delay-300">
          Esperienze incredibili ti aspettano a ComixCity!
        </p>
      </div>
    </section>

    <!-- FEEDBACK RICERCA -->
    <% if (query && query.q) { %>
      <div class="search-feedback anim-fade-down">
        <p>üîé Risultati per "<strong><%= query.q %></strong>"</p>
      </div>
    <% } %>

    <!-- CONTENUTO EVENTI -->
    <section class="eventi-main">
      <div class="eventi-container anim-fade-up delay-300">
        
        <% if (eventi && eventi.length > 0) { %>
          <div class="eventi-grid1">
            <% eventi.forEach((evento, index) => { %>
              <div class="evento-card anim-zoom-in delay-<%= 600 + (index * 100) %>" data-id="<%= evento.id %>"
                   data-title="<%= evento.titolo %>"
                   data-desc="<%= evento.descrizione %>"
                   data-img="<%= evento.img || '/img/placeholder-evento.jpg' %>"
                   data-prenotabile="<%= evento.prenotabile ? 1 : 0 %>"
                   data-luogo="<%= evento.luogo || 'Padiglione principale' %>"
                   data-features='["Data: <%= new Date(evento.data).toLocaleDateString('it-IT') %><%= evento.orario ? ' alle ' + evento.orario : '' %>", "Iscritti: <%= evento.iscritti_count || 0 %>", "Organizzato da ComixCity"]'>
              
                <% if (evento.img && evento.img.trim() !== '') { %>
                    <img src="<%= evento.img %>" 
                      alt="<%= evento.titolo %>" 
                      class="evento-image-normal"
                      onerror="this.classList.add('sr-only'); this.nextElementSibling.classList.remove('sr-only');" />
                        <div class="sr-only">
                          <p class="errore">Immagine non trovata: verificare /public<%= evento.img %></p>
                        </div>
                <% } else { %>
                        <!-- Usa una classe esistente o crea placeholder minimale -->
                      <div class="evento-placeholder-missing">
                        <p class="errore">NESSUNA IMMAGINE NEL DB</p>
                      </div>
                <% } %>
                
                <div class="evento-info">
                  <h3><%= evento.titolo %></h3>
                  <% 
                    const dataObj = new Date(evento.data);
                    const orarioFormattato = dataObj.toLocaleTimeString('it-IT', {hour: '2-digit', minute: '2-digit'});
                  %>
                  <p class="evento-orario">üïê <%= orarioFormattato %></p>
                  <!-- Descrizione tronca per invogliare ad aprire il modal -->
                  <p><%= evento.descrizione.length > 100 ? evento.descrizione.substring(0, 100) + '...' : evento.descrizione %></p>
                </div>
                
                <div class="evento-actions">
                  <% if (user) { %>
                    <% if (evento.prenotabile) { %>
                      <% if (evento.prenotato) { %>
                        <form method="POST" action="/eventi/<%= evento.id %>/annulla" class="inline-display">
                          <button type="submit" class="btn btn-danger">Annulla Prenotazione</button>
                        </form>
                      <% } else { %>
                        <form method="POST" action="/eventi/<%= evento.id %>/prenota" class="inline-display">
                          <input type="hidden" name="tipo_partecipazione" value="partecipante">
                          <button type="submit" class="btn-secondary">Prenota</button>
                        </form>
                      <% } %>
                    <% } else { %>
                      <button class="btn btn-secondary" disabled>Accesso libero</button>
                    <% } %>  
                  <% } else { %>
                    <a href="/login" class="btn-secondary">Login per prenotare</a>
                  <% } %>
                  
                  <button class="btn-info" type="button">Info</button>
                </div>
                
                <!-- Controlli Admin -->
                <% if (user && user.ruolo === 'admin') { %>
                  <div class="admin-controls" style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid #eee;">
                    <a href="/eventi/modifica/<%= evento.id %>" class="btn btn-sm" style="margin-right: 0.5rem;">Modifica</a>
                    <form method="POST" action="/eventi/elimina/<%= evento.id %>" style="display:inline;">
                      <button type="submit" class="btn btn-danger btn-sm" 
                              onclick="return confirm('Sicuro di eliminare questo evento? Tutte le prenotazioni verranno cancellate!')">Elimina</button>
                    </form>
                    
                  </div>
                <% } %>
              </div>
            <% }) %>
          </div>
        <% } else { %>
          <div class="no-eventi" style="text-align: center; padding: 4rem 2rem;">
            <h3>Nessun evento trovato</h3>
            <% if (query && query.q) { %>
              <p>Non ci sono eventi che corrispondono alla tua ricerca "<%= query.q %>".</p>
              <a href="/eventi" class="btn-secondary">Vedi tutti gli eventi</a>
            <% } else { %>
              <p>Gli eventi saranno pubblicati presto!</p>
              <% if (user && user.ruolo === 'admin') { %>
                <a href="/eventi/nuovo" class="btn-secondary">Crea il primo evento</a>
              <% } %>
            <% } %>
          </div>
        <% } %>

        <!-- MODAL EVENTO -->
        <div id="eventoModal" class="modal" aria-hidden="true" role="dialog" aria-modal="true">
          <div class="modal__backdrop" data-close></div>
          <div class="modal__panel" role="document" tabindex="-1">
            <button class="modal__close" aria-label="Chiudi" data-close>&times;</button>
            <div class="modal__media">
              <img id="modalImg" alt="" />
            </div>
            <div class="modal__body">
              <h3 id="modalTitle"></h3>
              <p id="modalDesc"></p>
              <ul id="modalFeat"></ul>
              <% if (user) { %>
                <a id="modalCta" href="#" class="btn-secondary">Prenota/Partecipa</a>
              <% } else { %>
                <a id="modalCta" href="/login" class="btn-secondary">Login per prenotare</a>
              <% } %>
            </div>
          </div>
        </div>
        <!-- /MODAL -->

      </div>
    </section>
    <!-- /CONTENUTO EVENTI -->

  </section>

  <%- include('partials/footer') %>
  <script src="/js/script.js"></script>
  <script src="/js/modal.js"></script>

  <script>
    document.addEventListener("DOMContentLoaded", () => {
      // Gestione evidenziazione da ricerca
      const urlParams = new URLSearchParams(window.location.search);
      const highlightId = urlParams.get("highlight");
      const searchTerm = urlParams.get("search");

      if (highlightId) {
        // Cerca l'elemento da evidenziare
        const targetElement =
          document.querySelector(`[data-id="${highlightId}"]`) ||
          document.querySelector(`#item-${highlightId}`) ||
          document.querySelector(`#biglietto-${highlightId}`) ||
          document.querySelector(`#evento-${highlightId}`) ||
          document.querySelector(`#stand-${highlightId}`);

        if (targetElement) {
          // Evidenzia l'elemento
          targetElement.classList.add("search-highlighted");

          // Scroll verso l'elemento
          setTimeout(() => {
            targetElement.scrollIntoView({
              behavior: "smooth",
              block: "center",
            });
          }, 500);

          // Rimuovi evidenziazione dopo 5 secondi
          setTimeout(() => {
            targetElement.classList.remove("search-highlighted");
          }, 5000);
        }

        // Mostra messaggio di ricerca se presente
        if (searchTerm) {
          const searchMessage = document.createElement("div");
          searchMessage.className = "search-result-message";
          searchMessage.innerHTML = `
            <div class="alert alert-info">
              üîç Risultato per: "<strong>${searchTerm}</strong>"
              <button onclick="this.parentElement.remove()" style="float: right; background: none; border: none; font-size: 1.2rem;">&times;</button>
            </div>
          `;
          document.body.insertBefore(searchMessage, document.body.firstChild);

          // Auto-rimuovi dopo 5 secondi
          setTimeout(() => {
            if (searchMessage.parentElement) {
              searchMessage.remove();
            }
          }, 5000);
        }
      }
    });
  </script>
</body>
</html>