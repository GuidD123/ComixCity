<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Checkout - ComixCity</title>
  <link rel="stylesheet" href="/css/stile.css" />
</head>
<body>
  <%- include('partials/navbar1') %>
  <%- include('partials/flashmex') %>

  <% if (typeof tuttoDisponibile !== 'undefined' && !tuttoDisponibile) { %>
  <div class="alert alert-warning anim-fade-up" style="max-width: 1200px; margin: 20px auto; padding: 15px; background: #fff3cd; border: 2px solid #ffc107; border-radius: 8px; text-align: center;">
    ‚ö†Ô∏è <strong>Attenzione:</strong> Alcuni biglietti potrebbero non essere pi√π disponibili nella quantit√† richiesta. Verifica il carrello prima di procedere.
  </div>
  <% } %>

  <section class="background-gradient">
    <!-- HERO CHECKOUT -->
    <section class="hero2 carrello-hero">
      <div class="hero-content-chisiamo">
        <h1 class="anim-fade-up">üí≥ Checkout</h1>
        <h2 class="anim-fade-up delay-300">
          Completa il tuo acquisto in sicurezza
        </h2>
      </div>
    </section>

    <section class="carrello-main">
      <div class="carrello-container anim-fade-up">
        
        <!-- RIEPILOGO ORDINE -->
        <div class="checkout-section">
          <h3>üìã Riepilogo Ordine</h3>
          <table class="carrello-tabella anim-fade-up delay-200">
            <caption class="sr-only">Riepilogo ordine</caption>
            <thead>
              <tr>
                <th>Biglietto</th>
                <th>Quantit√†</th>
                <th>Prezzo</th>
                <th>Totale</th>
              </tr>
            </thead>
            <tbody>
              <% if (carrello.length === 0) { %>
              <tr>
                <td colspan="4" class="carrello-vuoto">Il carrello √® vuoto.</td>
              </tr>
              <% } else { %>
                <% carrello.forEach(item => { %>
                <tr>
                  <td><%= item.nome %></td>
                  <td><%= item.quantita %></td>
                  <td>‚Ç¨<%= item.prezzo.toFixed(2) %></td>
                  <td>‚Ç¨<%= (item.quantita * item.prezzo).toFixed(2) %></td>
                </tr>
                <% }) %>
              <% } %>
            </tbody>
          </table>
          
          <div class="carrello-totale">
            <h3>üí∞ Totale: ‚Ç¨<%= Number(totale).toFixed(2) %></h3>
          </div>
        </div>

        <% if (carrello.length > 0) { %>
        <!-- FORM PAGAMENTO -->
        <div class="checkout-section payment-section anim-fade-up delay-400">
          <h3>üí≥ Metodo di Pagamento</h3>
          
          <form id="checkoutForm" method="POST" action="/carrello/checkout" class="payment-form">
            
            <!-- SELEZIONE METODO -->
            <div class="payment-methods">
              <label class="payment-method">
                <input type="radio" name="paymentMethod" value="card" checked>
                <div class="method-info">
                  <span class="method-icon">üí≥</span>
                  <span class="method-name">Carta di Credito</span>
                </div>
              </label>
              
              <label class="payment-method">
                <input type="radio" name="paymentMethod" value="paypal">
                <div class="method-info">
                  <span class="method-icon">üîµ</span>
                  <span class="method-name">PayPal</span>
                </div>
              </label>
              
              <label class="payment-method">
                <input type="radio" name="paymentMethod" value="bank">
                <div class="method-info">
                  <span class="method-icon">üè¶</span>
                  <span class="method-name">Bonifico Bancario</span>
                </div>
              </label>
            </div>

            <!-- FORM CARTA DI CREDITO -->
            <div id="cardForm" class="payment-form-section">
              <div class="form-row">
                <div class="form-group">
                  <label for="cardNumber">Numero Carta *</label>
                  <input type="text" id="cardNumber" name="cardNumber" 
                         placeholder="1234 5678 9012 3456" 
                         pattern="[0-9\s]{13,19}" 
                         maxlength="19"
                         required>
                  <div class="card-icons">
                    <span class="card-icon visa">üí≥</span>
                    <span class="card-icon mastercard">üí≥</span>
                  </div>
                </div>
              </div>
              
              <div class="form-row">
                <div class="form-group">
                  <label for="cardName">Nome Titolare *</label>
                  <input type="text" id="cardName" name="cardName" 
                         placeholder="Mario Rossi" 
                         pattern="[A-Za-z\s]{2,50}"
                         required>
                </div>
              </div>
              
              <div class="form-row">
                <div class="form-group half">
                  <label for="expiryDate">Scadenza *</label>
                  <input type="text" id="expiryDate" name="expiryDate" 
                         placeholder="MM/YY" 
                         pattern="[0-9]{2}/[0-9]{2}"
                         maxlength="5"
                         required>
                </div>
                
                <div class="form-group half">
                  <label for="cvv">CVV *</label>
                  <input type="text" id="cvv" name="cvv" 
                         placeholder="123" 
                         pattern="[0-9]{3,4}"
                         maxlength="4"
                         required>
                  <span class="cvv-help" title="Codice di 3 cifre sul retro della carta">‚ùì</span>
                </div>
              </div>
            </div>

            <!-- FORM PAYPAL -->
            <div id="paypalForm" class="payment-form-section" style="display: none;">
              <div class="paypal-info">
                <p>üîµ Verrai reindirizzato su PayPal per completare il pagamento in sicurezza.</p>
                <p><strong>Email PayPal:</strong> Useremo l'email del tuo account ComixCity</p>
              </div>
            </div>

            <!-- FORM BONIFICO -->
            <div id="bankForm" class="payment-form-section" style="display: none;">
              <div class="bank-info">
                <p>üè¶ <strong>Bonifico Bancario</strong></p>
                <div class="bank-details">
                  <p><strong>Beneficiario:</strong> ComixCity S.r.l.</p>
                  <p><strong>IBAN:</strong> IT60 X054 2811 1010 0000 0123 456</p>
                  <p><strong>Causale:</strong> Ordine #[verr√† generato automaticamente]</p>
                </div>
                <p class="bank-note">‚ö†Ô∏è L'ordine sar√† processato entro 1-2 giorni lavorativi dalla ricezione del bonifico.</p>
              </div>
            </div>

            <!-- DATI FATTURAZIONE -->
            <div class="billing-section">
              <h4>üìÑ Dati Fatturazione</h4>
              <div class="form-row">
                <div class="form-group">
                  <label for="billingName">Nome e Cognome *</label>
                  <input type="text" id="billingName" name="billingName" 
                         value="<%= user?.username || '' %>" required>
                </div>
              </div>
              
              <div class="form-row">
                <div class="form-group">
                  <label for="billingEmail">Email *</label>
                  <input type="email" id="billingEmail" name="billingEmail" 
                         value="<%= user?.email || '' %>" required>
                </div>
              </div>
              
              <div class="form-row">
                <div class="form-group half">
                  <label for="billingCity">Citt√† *</label>
                  <input type="text" id="billingCity" name="billingCity" required>
                </div>
                
                <div class="form-group half">
                  <label for="billingZip">CAP *</label>
                  <input type="text" id="billingZip" name="billingZip" 
                         pattern="[0-9]{5}" maxlength="5" required>
                </div>
              </div>
            </div>

            <!-- TERMINI E CONDIZIONI -->
            <div class="terms-section">
              <label class="checkbox-label">
                <input type="checkbox" id="acceptTerms" name="acceptTerms" required>
                <span class="checkmark">‚úì</span>
                Accetto i <a href="/terms" target="_blank">Termini e Condizioni</a> e la <a href="/privacy" target="_blank">Privacy Policy</a> *
              </label>
            </div>

            <!-- RIEPILOGO FINALE -->
            <div class="final-summary">
              <div class="summary-row">
                <span>Subtotale:</span>
                <span>‚Ç¨<%= Number(totale).toFixed(2) %></span>
              </div>
              <div class="summary-row">
                <span>Commissioni servizio:</span>
                <span>‚Ç¨0.00</span>
              </div>
              <div class="summary-row total">
                <span><strong>Totale finale:</strong></span>
                <span><strong>‚Ç¨<%= Number(totale).toFixed(2) %></strong></span>
              </div>
            </div>

            <!-- PULSANTI AZIONE -->
            <div class="checkout-actions">
              <button type="submit" class="btn btn-primary" id="submitPayment"  <%= (typeof tuttoDisponibile !== 'undefined' && !tuttoDisponibile) ? 'disabled' : '' %>>
                    <span class="btn-text">
                      <%= (typeof tuttoDisponibile !== 'undefined' && !tuttoDisponibile) ? '‚ö†Ô∏è Biglietti Non Disponibili' : 'üîí Completa Acquisto' %>
                    </span>
                <span class="btn-loading" style="display: none;">‚è≥ Elaborazione...</span>
              </button>
              
              <a href="/carrello" class="btn btn-secondary">
                ‚Üê Torna al Carrello
              </a>
            </div>

            <!-- SICUREZZA INFO -->
            <div class="security-info">
              <p>üîí <strong>Pagamento Sicuro</strong> - I tuoi dati sono protetti con crittografia SSL</p>
              <p>üõ°Ô∏è Non memorizziamo i dati della tua carta di credito</p>
            </div>

          </form>
        </div>
        <% } else { %>
        <div class="empty-cart">
          <p>Il carrello √® vuoto. <a href="/biglietti">Aggiungi alcuni biglietti</a> per continuare.</p>
        </div>
        <% } %>

      </div>
    </section>
  </section>

  <%- include('partials/footer1') %>
  <script src="/js/script.js"></script>
  <script src="/js/checkout.js"></script>

  <!-- Protezione client-side per prevenire submit quando biglietti non disponibili 
   Questa √® una protezione aggiuntiva lato client: il controllo definitivo
   avviene comunque nel backend durante il POST /checkout.-->
  <script>
  document.addEventListener('DOMContentLoaded', function() {
    const tuttoDisponibile = <%= typeof tuttoDisponibile !== 'undefined' ? tuttoDisponibile : true %>;
    const form = document.getElementById('checkoutForm');
    
    if (!tuttoDisponibile && form) {
      form.addEventListener('submit', function(e) {
        e.preventDefault();
        alert('‚ö†Ô∏è Alcuni biglietti non sono disponibili. Torna al carrello per aggiornare le quantit√†.');
        return false;
      });
    }
  });
  </script>

</body>
</html>